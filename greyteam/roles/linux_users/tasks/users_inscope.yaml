---
- name: Ensure admin users exist and are in sudo group
  ansible.builtin.user:
    name: "{{ item }}"
    password: "{{ team_password | ansible.builtin.password_hash('sha512') }}" 
    groups: sudo
    # groups: "{{ ['sudo'] + linux_groups }}"
    append: yes
    shell: /bin/bash
    create_home: yes 
  loop: "{{ local_admins }}"

- name: Ensure redteam admin user exist and is in sudo group
  ansible.builtin.user:
    name: "{{ redteam_user }}"
    password: "{{ redteam_password | ansible.builtin.password_hash('sha512') }}" 
    groups: sudo
    # groups: "{{ ['sudo'] + linux_groups }}"
    append: yes
    shell: /bin/bash
    create_home: yes 

- name: Ensure regular users exist
  ansible.builtin.user:
    name: "{{ item }}"
    password: "{{ team_password | ansible.builtin.password_hash('sha512') }}" 
    groups: users
    append: yes
    shell: /bin/bash
    create_home: yes
  loop: "{{ local_users }}"

- name: Configure LXQt session for XRDP
  ansible.builtin.copy:
    dest: "/home/{{ item }}/.xsession"
    content: "startlxqt"
    owner: "{{ item }}"
    group: "{{ item }}"
    mode: '0644'
  loop: "{{ local_users + local_admins + [redteam_user] }}"
  when: "'gui' in group_names"