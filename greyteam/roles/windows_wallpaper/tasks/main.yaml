---
# Alpha â€“ Anny Hua
# Feature: Windows wallpaper theming 

- name: Determine wallpaper filename for this host (prefer hostname.jpg)
  ansible.builtin.set_fact:
    wallpaper_host_file: "{{ inventory_hostname.split('.')[0] }}.jpg"
    wallpaper_default_file: "wallpaper.jpg"

- name: Check if hostname-specific wallpaper exists on controller
  ansible.builtin.stat:
    path: "{{ role_path }}/files/{{ wallpaper_host_file }}"
  register: wallpaper_check
  delegate_to: localhost
  run_once: false

- name: Choose wallpaper source file (host-specific or default)
  ansible.builtin.set_fact:
    wallpaper_src: "{{ wallpaper_host_file if wallpaper_check.stat.exists else wallpaper_default_file }}"

- name: Ensure wallpaper directory exists
  ansible.windows.win_file:
    path: "C:\\ProgramData\\Inscope\\Branding"
    state: directory

- name: Copy wallpaper to host
  ansible.windows.win_copy:
    src: "{{ wallpaper_src }}"
    dest: "C:\\ProgramData\\Inscope\\Branding\\wallpaper.jpg"

- name: Ensure all users can read wallpaper
  ansible.windows.win_acl:
    path: C:\ProgramData\Inscope\Branding\wallpaper.jpg
    user: Users
    rights: Read
    type: allow
    state: present

- name: Configure wallpaper registry values
  ansible.windows.win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\Personalization
    name: "{{ item.name }}"
    data: "{{ item.data }}"
    type: string
  loop:
    - { name: "Wallpaper",      data: "C:\\ProgramData\\Inscope\\Branding\\wallpaper.jpg" }
    - { name: "WallpaperStyle", data: "10" }

- name: Refresh desktop settings (apply wallpaper)
  ansible.windows.win_shell: gpupdate /force
  changed_when: false

- name: Verify wallpaper registry points to expected file
  ansible.windows.win_shell: |
    (Get-ItemProperty "HKLM:\Software\Policies\Microsoft\Windows\Personalization").Wallpaper
  register: wallpaper_reg
  changed_when: false

- name: Show applied wallpaper path
  ansible.builtin.debug:
    msg: "Wallpaper set to: {{ wallpaper_reg.stdout | trim }}"

- name: Force wallpaper for currently logged-in users
  ansible.windows.win_shell: |
    $users = Get-ChildItem HKU: | Where-Object { $_.Name -match "S-1-5-21" }
    foreach ($u in $users) {
      Set-ItemProperty "$($u.Name)\Control Panel\Desktop" -Name Wallpaper -Value "C:\ProgramData\Inscope\Branding\wallpaper.jpg"
      Set-ItemProperty "$($u.Name)\Control Panel\Desktop" -Name WallpaperStyle -Value "10"
      Set-ItemProperty "$($u.Name)\Control Panel\Desktop" -Name TileWallpaper -Value "0"
    }
    RUNDLL32.EXE user32.dll,UpdatePerUserSystemParameters