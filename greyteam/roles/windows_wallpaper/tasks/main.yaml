---
# Alpha â€“ Anny Hua
# Feature: Windows wallpaper theming 
- name: Determine wallpaper filename for this host (prefer hostname.jpg)
  ansible.builtin.set_fact:
    wallpaper_host_file: "{{ inventory_hostname.split('.')[0] }}.jpg"
    wallpaper_default_file: "wallpaper.jpg"

- name: Check if hostname-specific wallpaper exists on controller
  ansible.builtin.stat:
    path: "{{ role_path }}/files/{{ wallpaper_host_file }}"
  register: wallpaper_check
  delegate_to: localhost
  run_once: false

- name: Choose wallpaper source file (host-specific or default)
  ansible.builtin.set_fact:
    wallpaper_src: "{{ wallpaper_host_file if wallpaper_check.stat.exists else wallpaper_default_file }}"

- name: Ensure wallpaper directory exists
  ansible.windows.win_file:
    path: "C:\\ProgramData\\Inscope\\Branding"
    state: directory

- name: Copy wallpaper to host
  ansible.windows.win_copy:
    src: "{{ wallpaper_src }}"
    dest: "C:\\ProgramData\\Inscope\\Branding\\wallpaper.jpg"

- name: Copy wallpaper script to host
  ansible.windows.win_copy:
    src: "wallpaper_script.ps1"
    dest: "C:\\ProgramData\\Inscope\\"

- name: Create wallpaper scheduled task (run at logon with delay)
  ansible.windows.win_scheduled_task:
    name: WallpaperInit
    description: Apply custom wallpaper at first login
    actions:
      - path: powershell.exe
        arguments: -NoProfile -ExecutionPolicy Bypass -File C:\ProgramData\Inscope\wallpaper_script.ps1
    triggers:
      - type: logon
        delay: PT15S
    username: SYSTEM
    run_level: highest
    state: present

