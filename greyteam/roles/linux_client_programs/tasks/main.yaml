---
#Author: Darius Flontas (daf2478)

# 1) Package installation

# Refresh apt package
- name: Update apt cache
  ansible.builtin.apt:
    update_cache: yes
    cache_valid_time: 3600
  become: true

# Install the required workstation applications from linux_client_programs/defaults/main.yaml
- name: Install Linux client programs
  ansible.builtin.apt:
    name: "{{ linux_client_programs_packages }}"
    state: present
  become: true

# Safety refresh
- name: Update apt cache
  ansible.builtin.apt:
    update_cache: yes
  become: true

# 2) Connectivity checks (FTP & IRC)

# Tries to open a TCP connection to the FTP server/port from the workstation
- name: Verify FTP server is reachable from workstations
  ansible.builtin.wait_for:
    host: "{{ ftp_host }}"
    port: "{{ ftp_port }}"
    timeout: 10
  register: ftp_reachable
  failed_when: false
  changed_when: false

# Same idea as above, but for IRC (ngircd) TCP port
- name: Verify IRC server is reachable from workstations
  ansible.builtin.wait_for:
    host: "{{ irc_host }}"
    port: "{{ irc_port }}"
    timeout: 10
  register: irc_reachable
  failed_when: false
  changed_when: false

# Print a clean YES/NO so we can quickly see if services are reachable
- name: Display connectivity results
  ansible.builtin.debug:
    msg: |
      - "FTP server ({{ ftp_host }}:{{ ftp_port }}) reachable: {{ 'YES' if not ftp_reachable.failed else 'NO' }}"
      - "IRC server ({{ irc_host }}:{{ irc_port }}) reachable: {{ 'YES' if not irc_reachable.failed else 'NO' }}"
  changed_when: false

# 3) Desktop shortcuts for installed applications

# Create /etc/skel/Desktop so any future users created on the box inherit these shortcuts (might delete once all users are finalized)
- name: Fix desktop skeleton path
  ansible.builtin.file:
    path: /etc/skel/Desktop
    state: directory
    mode: "0755"
  become: true

# Pulls /etc/passwd into ansible_facts.getent_passwd so we can verify usernames exist
# also prevents errors when looping over non-existent users
- name: Load passwd entries (so we can check users exist)
  ansible.builtin.getent:
    database: passwd
  become: true

# Creates /usr/skel/Desktop (default on path on ubuntu)
- name: Ensure desktop exsists for all users
  ansible.builtin.file:
    path: /usr/skel/Desktop
    state: directory
    mode: '0755'
  become: true

# Make sure each target user has a Desktop folder so we can drop shortcuts there
- name: Ensure desktop exisits for existing users
  ansible.builtin.file:
    path: "/home/{{ item }}/Desktop"
    state: directory
    owner: "{{ item }}"
    group: "{{ item }}"
    mode: '0755'
  loop: "{{ linux_desktop_users }}"
  when: item in ansible_facts.getent_passwd
  become: true


# Create simple .desktop launchers that run each program by name
- name: Create app launchers in /etc/skel/Desktop
  ansible.builtin.copy:
    dest: "/etc/skel/Desktop/{{ item.filename }}"
    mode: "0755"
    content: |
      [Desktop Entry]
      Type=Application
      Name={{ item.name }}
      Exec={{ item.exec }}
      Terminal=false
  loop:
    - { name: "Thunderbird", filename: "Thunderbird.desktop", exec: "thunderbird" }
    - { name: "LibreOffice", filename: "LibreOffice.desktop", exec: "libreoffice" }
    - { name: "FileZilla", filename: "FileZilla.desktop", exec: "filezilla" }
    - { name: "HexChat", filename: "HexChat.desktop", exec: "hexchat" }
  become: true

# Copies the launcher templates from /etc/skel/Desktop into every existing userâ€™s Desktop folder
# Uses product() so we do each user times each launcher without writing 4 separate tasks
- name: Copy launchers to each user Desktop
  ansible.builtin.copy:
    remote_src: true
    src: "/etc/skel/Desktop/{{ item.1 }}"
    dest: "/home/{{ item.0 }}/Desktop/{{ item.1 }}"
    owner: "{{ item.0 }}"
    group: "{{ item.0 }}"
    mode: "0755"
  loop: "{{ linux_desktop_users | product(['Thunderbird.desktop','LibreOffice.desktop','FileZilla.desktop','HexChat.desktop']) | list }}"
  when: item.0 in ansible_facts.getent_passwd
  become: true



#- name: Create Desktop Symbolic Links (all shortcuts)
#  ansible.builtin.file:
#    src: "{{ item.1.src }}"
#    dest: "/home/{{ item.0 }}/Desktop/{{ item.1.dest }}"
#    state: link
#    owner: "{{ item.0 }}"
#    group: "{{ item.0 }}"
#    mode: "0755"
#    force: true
#  loop: "{{ query('nested', linux_desktop_users, shortcuts) }}"
#  when: item.0 in ansible_facts.getent_passwd
#  vars:
#    shortcuts:
#      
#      - { src: "/usr/share/applications/thunderbird.desktop",              dest: "Thunderbird.desktop" }
#      - { src: "/usr/share/applications/libreoffice-startcenter.desktop",  dest: "LibreOffice.desktop" }
#      - { src: "/usr/share/applications/filezilla.desktop",                dest: "FileZilla.desktop" }
#      - { src: "/usr/share/applications/hexchat.desktop",                  dest: "HexChat.desktop" }
#  ignore_errors: yes
#  register: desktop_links
#  become: true