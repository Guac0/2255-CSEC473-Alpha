---
- name: Update apt cache
  ansible.builtin.apt:
    update_cache: yes
    cache_valid_time: 3600
  become: true

- name: Install Linux client programs
  ansible.builtin.apt:
    name: "{{ linux_client_programs_packages }}"
    state: present
  become: true

- name: Update apt cache
  ansible.builtin.apt:
    update_cache: yes
  become: true

- name: Verify FTP server is reachable from workstations
  ansible.builtin.wait_for:
    host: "{{ ftp_host }}"
    port: "{{ ftp_port }}"
    timeout: 10
  register: ftp_reachable
  failed_when: false
  changed_when: false

- name: Verify IRC server is reachable from workstations
  ansible.builtin.wait_for:
    host: "{{ irc_host }}"
    port: "{{ irc_port }}"
    timeout: 10
  register: irc_reachable
  failed_when: false
  changed_when: false

- name: Display connectivity results
  ansible.builtin.debug:
    msg: |
      - "FTP server ({{ ftp_host }}:{{ ftp_port }}) reachable: {{ 'YES' if not ftp_reachable.failed else 'NO' }}"
      - "IRC server ({{ irc_host }}:{{ irc_port }}) reachable: {{ 'YES' if not irc_reachable.failed else 'NO' }}"
  changed_when: false

- name: Ensure desktop exsists for all users
  ansible.builtin.file:
    path: /usr/skel/Desktop
    state: directory
    mode: '0755'
  become: true

- name: Ensure desktop exisits for existing users
  ansible.builtin.file:
    path: "/home/{{ item }}/Desktop"
    state: directory
    owner: "{{ item }}"
    group: "{{ item }}"
    mode: '0755'
  loop: "{{ linux_desktop_user }}"
  become: true

- name: Find thunderbird launcher
  ansible.builtin.find:
    paths:
      - /usr/share/applications
    patterns: "*thunderbird*.desktop"
    file_type: file
  register: thunderbird_desktop
  become: true

- name: Find libreoffice launcher
  ansible.builtin.find:
    paths:
      - /usr/share/applications
    patterns: "*libreoffice*.desktop"
    file_type: file
  register: libreoffice_desktop
  become: true

- name: Find filezilla launcher
  ansible.builtin.find:
    paths:
      - /usr/share/applications
    patterns: "*filezilla*.desktop"
    file_type: file
  register: filezilla_desktop
  become: true

- name: Find hexchat launcher
  ansible.builtin.find:
    paths:
      - /usr/share/applications
    patterns: "*hexchat*.desktop"
    file_type: file
  register: hexchat_desktop
  become: true

- name: Copy Thunderbird shortcut to /etc/skel/Desktop
  ansible.builtin.copy:
    remote_src: true
    src: "{{ tb_desktop.files[0].path }}"
    dest: /etc/skel/Desktop/Thunderbird.desktop
    mode: "0755"
  when: thunderbird_desktop.matched | int > 0
  become: true

- name: Copy LibreOffice shortcut to /etc/skel/Desktop
  ansible.builtin.copy:
    remote_src: true
    src: "{{ libreoffice_desktop.files[0].path }}"
    dest: /etc/skel/Desktop/LibreOffice.desktop
    mode: "0755"
  when: libreoffice_desktop.matched | int > 0
  become: true

- name: Copy FileZilla shortcut to /etc/skel/Desktop
  ansible.builtin.copy:
    remote_src: true
    src: "{{ filezilla_desktop.files[0].path }}"
    dest: /etc/skel/Desktop/FileZilla.desktop
    mode: "0755"
  when: filezilla_desktop.matched | int > 0
  become: true

- name: Copy HexChat shortcut to /etc/skel/Desktop
  ansible.builtin.copy:
    remote_src: true
    src: "{{ hexchat_desktop.files[0].path }}"
    dest: /etc/skel/Desktop/HexChat.desktop
    mode: "0755"
  when: hexchat_desktop.matched | int > 0
  become: true

- name: Copy Thunderbird shortcut to each user Desktop
  ansible.builtin.copy:
    remote_src: true
    src: "{{ thunderbird_desktop.files[0].path }}"
    dest: "/home/{{ item }}/Desktop/Thunderbird.desktop"
    owner: "{{ item }}"
    group: "{{ item }}"
    mode: "0755"
  loop: "{{ linux_desktop_users }}"
  when:
    - thunderbird_desktop.matched | int > 0
    - item in getent_passwd
  become: true

- name: Copy LibreOffice shortcut to each user Desktop
  ansible.builtin.copy:
    remote_src: true
    src: "{{ libreoffice_desktop.files[0].path }}"
    dest: "/home/{{ item }}/Desktop/LibreOffice.desktop"
    owner: "{{ item }}"
    group: "{{ item }}"
    mode: "0755"
  loop: "{{ linux_desktop_users }}"
  when:
    - libreoffice_desktop.matched | int > 0
    - item in getent_passwd
  become: true

- name: Copy FileZilla shortcut to each user Desktop
  ansible.builtin.copy:
    remote_src: true
    src: "{{ filezilla_desktop.files[0].path }}"
    dest: "/home/{{ item }}/Desktop/FileZilla.desktop"
    owner: "{{ item }}"
    group: "{{ item }}"
    mode: "0755"
  loop: "{{ linux_desktop_users }}"
  when:
    - filezilla_desktop.matched | int > 0
    - item in getent_passwd
  become: true

- name: Copy HexChat shortcut to each user Desktop
  ansible.builtin.copy:
    remote_src: true
    src: "{{ hexchat_desktop.files[0].path }}"
    dest: "/home/{{ item }}/Desktop/HexChat.desktop"
    owner: "{{ item }}"
    group: "{{ item }}"
    mode: "0755"
  loop: "{{ linux_desktop_users }}"
  when:
    - hexchat_desktop.matched | int > 0
    - item in getent_passwd
  become: true