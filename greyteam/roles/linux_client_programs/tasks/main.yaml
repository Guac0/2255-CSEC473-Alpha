---
- name: Update apt cache
  ansible.builtin.apt:
    update_cache: yes
    cache_valid_time: 3600
  become: true

- name: Install Linux client programs
  ansible.builtin.apt:
    name: "{{ linux_client_programs_packages }}"
    state: present
  become: true

- name: Update apt cache
  ansible.builtin.apt:
    update_cache: yes
  become: true

- name: Verify FTP server is reachable from workstations
  ansible.builtin.wait_for:
    host: "{{ ftp_host }}"
    port: "{{ ftp_port }}"
    timeout: 10
  register: ftp_reachable
  failed_when: false
  changed_when: false

- name: Verify IRC server is reachable from workstations
  ansible.builtin.wait_for:
    host: "{{ irc_host }}"
    port: "{{ irc_port }}"
    timeout: 10
  register: irc_reachable
  failed_when: false
  changed_when: false

- name: Display connectivity results
  ansible.builtin.debug:
    msg: |
      - "FTP server ({{ ftp_host }}:{{ ftp_port }}) reachable: {{ 'YES' if not ftp_reachable.failed else 'NO' }}"
      - "IRC server ({{ irc_host }}:{{ irc_port }}) reachable: {{ 'YES' if not irc_reachable.failed else 'NO' }}"
  changed_when: false

- name: Fix desktop skeleton path
  ansible.builtin.file:
    path: /etc/skel/Desktop
    state: directory
    mode: "0755"
  become: true

- name: Load passwd entries (so we can check users exist)
  ansible.builtin.getent:
    database: passwd
  become: true

- name: Ensure desktop exsists for all users
  ansible.builtin.file:
    path: /usr/skel/Desktop
    state: directory
    mode: '0755'
  become: true

- name: Ensure desktop exisits for existing users
  ansible.builtin.file:
    path: "/home/{{ item }}/Desktop"
    state: directory
    owner: "{{ item }}"
    group: "{{ item }}"
    mode: '0755'
  loop: "{{ linux_desktop_users }}"
  become: true

- name: Create app launchers in /etc/skel/Desktop
  ansible.builtin.copy:
    dest: "/etc/skel/Desktop/{{ item.filename }}"
    mode: "0755"
    content: |
      [Desktop Entry]
      Type=Application
      Name={{ item.name }}
      Exec={{ item.exec }}
      Terminal=false
  loop:
    - { name: "Thunderbird", filename: "Thunderbird.desktop", exec: "thunderbird" }
    - { name: "LibreOffice", filename: "LibreOffice.desktop", exec: "libreoffice" }
    - { name: "FileZilla", filename: "FileZilla.desktop", exec: "filezilla" }
    - { name: "HexChat", filename: "HexChat.desktop", exec: "hexchat" }
  become: true

- name: Copy launchers to each user Desktop
  ansible.builtin.copy:
    remote_src: true
    src: "/etc/skel/Desktop/{{ item.1 }}"
    dest: "/home/{{ item.0 }}/Desktop/{{ item.1 }}"
    owner: "{{ item.0 }}"
    group: "{{ item.0 }}"
    mode: "0755"
  loop: "{{ linux_desktop_users | product(['Thunderbird.desktop','LibreOffice.desktop','FileZilla.desktop','HexChat.desktop']) | list }}"
  when: item.0 in ansible_facts.getent_passwd
  become: true