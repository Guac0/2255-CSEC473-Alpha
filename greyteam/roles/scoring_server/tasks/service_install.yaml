---
- name: Deploy Scoring Worker Service
  copy:
    dest: /etc/systemd/system/scoring-worker.service
    content: |
      [Unit]
      Description=Scoring Background Worker
      After=network.target

      [Service]
      Type=notify
      User=root
      WorkingDirectory={{ scoring_deploy_dir }}
      ExecStart={{ scoring_deploy_dir }}/venv/bin/python3 worker.py
      Restart=always
      TimeoutStartSec=30

      [Install]
      WantedBy=multi-user.target

- name: Deploy Scoring Gunicorn Service
  copy:
    dest: /etc/systemd/system/scoring-server.service
    content: |
      [Unit]
      Description=Scoring Gunicorn Server
      After=network.target scoring-worker.service
      Requires=scoring-worker.service

      [Service]
      User=root
      WorkingDirectory={{ scoring_deploy_dir }}
      ExecStart={{ scoring_deploy_dir }}/venv/bin/gunicorn \
        --certfile=cert.pem \
        --keyfile=key.pem \
        --workers {{ scoring_gunicorn_workers }} \
        --bind 0.0.0.0:{{ scoring_port }} \
        server:app
      Restart=always

      [Install]
      WantedBy=multi-user.target